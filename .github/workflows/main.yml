name: Monthly dbt Pipeline

on:
  # 1. D√©clenchement manuel
  workflow_dispatch:
  
  # 2. D√©clenchement automatique (Tous les 1er du mois √† 06h00)
  schedule:
    - cron: '0 6 1 * *'

jobs:
  dbt_run:
    name: Run dbt Pipeline
    runs-on: ubuntu-latest

    # üöÄ OPTIMISATION : On d√©finit les variables ICI pour tous les steps
    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
      # Cette variable aide dbt √† ne pas spammer les logs
      DBT_PROFILES_DIR: ./ 

    steps:
      # A. R√©cup√©rer le code
      - name: Checkout code
        uses: actions/checkout@v3

      # B. Installer Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      # C. Installer TOUTES les librairies (Python + dbt)
      # Assure-toi que dbt-snowflake est bien dans requirements.txt
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # D. Lancer le script de chargement Python
      - name: Run Load Data Script
        run: python load_data.py

      # E. Installer les d√©pendances dbt (packages.yml)
      - name: Install dbt packages
        run: dbt deps

      # F. Lancer le pipeline dbt
      - name: Run dbt models
        run: dbt run

      # G. Tester la qualit√© des donn√©es
      - name: Test dbt models
        run: dbt test
